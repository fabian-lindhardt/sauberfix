<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SauberFix Dienstleistungen</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 1200px; margin: 2rem auto; padding: 0 1rem; background-color: #f4f4f9; color: #333; }
        .hidden { display: none; }
        .card { background: white; border: 1px solid #e1e4e8; padding: 1.5rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        h1 { color: #0056b3; }
        input, select, button { padding: 0.6rem; margin-bottom: 0.6rem; width: 100%; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        button { cursor: pointer; background: #007bff; color: white; border: none; font-weight: 600; }
        button:hover { background: #0056b3; }
        button.secondary { background: #6c757d; }
        button.delete { background: #dc3545; width: auto; padding: 0.3rem 0.6rem; font-size: 0.85rem; margin-right: 5px; }
        button.edit { background: #ffc107; color: black; width: auto; padding: 0.3rem 0.6rem; font-size: 0.85rem; }
        .admin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; background: white; }
        th { background: #007bff; color: white; padding: 0.8rem; text-align: left; }
        td { padding: 0.8rem; border-bottom: 1px solid #eee; }
        .email-sent { color: green; font-weight: bold; }
        .email-wait { color: orange; }
        .msg-success { color: green; font-weight: bold; margin-top: 5px; }
        .msg-error { color: red; font-weight: bold; margin-top: 5px; }
    </style>
</head>
<body>
    <div style="display:flex; justify-content:space-between;">
        <h1>ðŸ§¹ SauberFix Dienstleistungen</h1>
        <div id="userInfo" class="hidden">
            <span id="welcomeMsg"></span>
            <button onclick="window.location.href='scheduler.html'" class="secondary" style="width:auto;">ðŸ“… Kalender</button>
            <button onclick="logout()" class="secondary" style="width:auto;">Abmelden</button>
        </div>
    </div>

    <div id="loginSection">
        <div class="card" style="max-width: 400px; margin: 4rem auto;">
            <h2>Login</h2>
            <input type="text" id="loginUser" placeholder="Benutzername" />
            <input type="password" id="loginPass" placeholder="Passwort" />
            <button onclick="login()">Anmelden</button>
        </div>
    </div>

    <div id="dashboardSection" class="hidden">
        <div id="adminArea" class="hidden">
            <div class="admin-grid">
                <div class="card">
                    <h3 id="lblKunde">ðŸ‘¥ Neuer Kunde</h3>
                    <input type="hidden" id="editK_Id" />
                    <div style="display:flex; gap:5px;"><input type="text" id="nk_Vor" placeholder="Vorname" /><input type="text" id="nk_Nach" placeholder="Nachname" /></div>
                    <input type="text" id="nk_Strasse" placeholder="StraÃŸe & Hausnr." />
                    <div style="display:flex; gap:5px;"><input type="text" id="nk_Plz" placeholder="PLZ" style="width:80px;" /><input type="text" id="nk_Stadt" placeholder="Stadt" /></div>
                    <input type="email" id="nk_Email" placeholder="E-Mail Adresse" /><input type="text" id="nk_Tel" placeholder="Telefonnummer" />
                    
                    <button id="btnKunde" onclick="saveKunde()">Kunde speichern</button>
                    <button id="btnCancelK" onclick="resetKundeForm()" class="secondary hidden">Abbrechen</button>
                    <p id="msgKunde"></p>
                </div>

                <div class="card">
                    <h3 id="lblTermin">ðŸ“… Neuer Termin</h3>
                    <input type="hidden" id="editT_Id" /> 
                    <label>Wann?</label><input type="datetime-local" id="newT_Datum" />
                    <label>Was?</label><input type="text" id="newT_Desc" placeholder="Beschreibung" />
                    <label>Bei wem?</label><select id="newT_Kunde"></select>
                    <label>Wer macht's?</label><select id="newT_MA"></select>
                    
                    <button id="btnTermin" onclick="saveTermin()">Termin buchen</button>
                    <button id="btnCancelT" onclick="resetTerminForm()" class="secondary hidden">Abbrechen</button>
                    <p id="msgTermin"></p>
                </div>

                <div class="card">
                    <h3 id="lblMA">ðŸ‘· Neuer Mitarbeiter</h3>
                    <input type="hidden" id="editM_Id" />
                    <input type="text" id="newM_User" placeholder="Username" />
                    <input type="password" id="newM_Pass" placeholder="Passwort" />
                    <div style="display:flex; gap:5px;"><input type="text" id="newM_Vor" placeholder="Vorname" /><input type="text" id="newM_Nach" placeholder="Nachname" /></div>
                    <select id="newM_Rolle"><option value="User">Mitarbeiter (User)</option><option value="Admin">Verwaltung (Admin)</option></select>
                    
                    <button id="btnMA" onclick="saveMitarbeiter()">Mitarbeiter anlegen</button>
                    <button id="btnCancelM" onclick="resetMitarbeiterForm()" class="secondary hidden">Abbrechen</button>
                    <p id="msgMitarbeiter"></p>
                </div>
            </div>
            
            <div class="card" style="margin-bottom:1rem;">
                <h3>Kunden Ãœbersicht</h3>
                <table><thead><tr><th>Name</th><th>Adresse</th><th>Aktion</th></tr></thead><tbody id="kundenTable"></tbody></table>
            </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between;"><h3>Aktuelle Termine</h3><button onclick="loadTermine()" style="width:auto;">ðŸ”„ Aktualisieren</button></div>
            <table>
                <thead><tr><th>Datum & Uhrzeit</th><th>Beschreibung</th><th>Kunde</th><th>Mitarbeiter</th><th>Status</th><th>Aktion</th></tr></thead>
                <tbody id="termineTable"></tbody>
            </table>
        </div>
        
        <div id="maListCard" class="card hidden" style="margin-top:1rem;">
             <h3>Mitarbeiter Ãœbersicht</h3>
             <table><thead><tr><th>User</th><th>Name</th><th>Rolle</th><th>Aktion</th></tr></thead><tbody id="maTable"></tbody></table>
        </div>
    </div>

    <script>
        if(localStorage.getItem('token')) showDashboard();

        async function login() {
            try {
                const res = await fetch('/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:document.getElementById('loginUser').value, password:document.getElementById('loginPass').value})});
                if(!res.ok) throw new Error();
                const d = await res.json();
                localStorage.setItem('token', d.token); localStorage.setItem('role', d.rolle); localStorage.setItem('user', d.username);
                showDashboard();
            } catch { alert("Login fehlgeschlagen"); }
        }
        function logout() { localStorage.clear(); location.reload(); }

        function showDashboard() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('welcomeMsg').innerText = localStorage.getItem('user') + " (" + localStorage.getItem('role') + ")";
            
            if(localStorage.getItem('role') === 'Admin') {
                document.getElementById('adminArea').classList.remove('hidden');
                document.getElementById('maListCard').classList.remove('hidden');
                loadDropdowns();
                loadMitarbeiterTable();
                loadKundenTable(); 
            }
            loadTermine();
        }

        // --- INTELLIGENTE FEHLERBEHANDLUNG ---
        async function handleError(response, msgElementId) {
            const rawText = await response.text();
            let errorMessage = rawText;
            
            // Versuchen, das JSON zu parsen
            try {
                const json = JSON.parse(rawText);
                // Wenn es ein Feld "detail" gibt (Standard bei .NET ProblemDetails), nimm das
                if (json.detail) errorMessage = json.detail;
                else if (json.title) errorMessage = json.title;
            } catch(e) {
                // War kein JSON, wir nehmen den rohen Text
            }
            
            alert("âš ï¸ " + errorMessage);
            
            if(msgElementId) {
                const el = document.getElementById(msgElementId);
                el.innerText = errorMessage;
                el.className = "msg-error";
            }
        }

        async function loadTermine() {
            const res = await fetch('/termine', { headers: {'Authorization': 'Bearer '+localStorage.getItem('token')} });
            if(res.status===401) { logout(); return; }
            const data = await res.json();
            const tbody = document.getElementById('termineTable'); tbody.innerHTML = '';
            
            data.forEach(t => {
                const mailStatus = t.erinnerungVerschickt ? '<span class="email-sent">Ja âœ…</span>' : '<span class="email-wait">Geplant</span>';
                let btns = '';
                if(localStorage.getItem('role') === 'Admin') {
                    const json = JSON.stringify(t).replace(/"/g, '&quot;');
                    btns = `<button class="edit" onclick="editTermin(${json})">Edit</button>
                            <button class="delete" onclick="deleteTermin(${t.id})">LÃ¶schen</button>`;
                }
                tbody.innerHTML += `<tr><td>${new Date(t.datumUhrzeit).toLocaleString('de-DE')}</td><td>${t.beschreibung}</td><td>${t.kundeName}</td><td>${t.mitarbeiterName}</td><td>${mailStatus}</td><td>${btns}</td></tr>`;
            });
        }
        
        async function loadKundenTable() {
            const res = await fetch('/kunden');
            const data = await res.json();
            const tbody = document.getElementById('kundenTable'); tbody.innerHTML = '';
            data.forEach(k => {
                const json = JSON.stringify(k).replace(/"/g, '&quot;');
                tbody.innerHTML += `<tr>
                    <td>${k.vorname} ${k.nachname}</td>
                    <td>${k.strasse || ''}, ${k.plz} ${k.stadt}</td>
                    <td>
                        <button class="edit" onclick="editKunde(${json})">Edit</button>
                        <button class="delete" onclick="deleteKunde(${k.id})">LÃ¶schen</button>
                    </td>
                </tr>`;
            });
        }
        
        // --- KUNDEN LOGIK ---
        function editKunde(k) {
            document.getElementById('lblKunde').innerText = "Kunde bearbeiten (ID: "+k.id+")";
            document.getElementById('btnKunde').innerText = "Speichern";
            document.getElementById('btnCancelK').classList.remove('hidden');
            document.getElementById('editK_Id').value = k.id;
            
            document.getElementById('nk_Vor').value = k.vorname;
            document.getElementById('nk_Nach').value = k.nachname;
            document.getElementById('nk_Plz').value = k.plz;
            document.getElementById('nk_Stadt').value = k.stadt;
            document.getElementById('nk_Strasse').value = k.strasse || '';
            document.getElementById('nk_Email').value = k.email || '';
            document.getElementById('nk_Tel').value = k.telefon || '';
        }
        
        function resetKundeForm() {
            document.getElementById('lblKunde').innerText = "ðŸ‘¥ Neuer Kunde";
            document.getElementById('btnKunde').innerText = "Kunde speichern";
            document.getElementById('btnCancelK').classList.add('hidden');
            document.getElementById('editK_Id').value = '';
            document.getElementById('nk_Vor').value = ''; document.getElementById('nk_Nach').value = '';
            document.getElementById('nk_Plz').value = ''; document.getElementById('nk_Stadt').value = '';
            document.getElementById('nk_Strasse').value = ''; document.getElementById('nk_Email').value = ''; document.getElementById('nk_Tel').value = '';
            document.getElementById('msgKunde').innerText = '';
        }

        async function saveKunde() {
            const id = document.getElementById('editK_Id').value;
            const body = {
                vorname: document.getElementById('nk_Vor').value,
                nachname: document.getElementById('nk_Nach').value,
                strasse: document.getElementById('nk_Strasse').value,
                plz: document.getElementById('nk_Plz').value,
                stadt: document.getElementById('nk_Stadt').value,
                email: document.getElementById('nk_Email').value,
                telefon: document.getElementById('nk_Tel').value
            };
            const url = id ? '/kunden/' + id : '/kunden';
            const method = id ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, { method: method, headers: {'Content-Type':'application/json', 'Authorization':'Bearer '+localStorage.getItem('token')}, body:JSON.stringify(body)});
                if(res.ok) { 
                    document.getElementById('msgKunde').innerText = "Kunde gespeichert!"; 
                    document.getElementById('msgKunde').className = "msg-success";
                    resetKundeForm(); loadKundenTable(); loadDropdowns();
                } else { 
                    await handleError(res, 'msgKunde'); 
                }
            } catch(e) { alert(e); }
        }
        
        async function deleteKunde(id) {
            if(!confirm("Kunde wirklich lÃ¶schen?")) return;
            await fetch('/kunden/'+id, {method:'DELETE', headers:{'Authorization':'Bearer '+localStorage.getItem('token')}});
            loadKundenTable(); loadDropdowns();
        }

        // --- MITARBEITER LOGIK ---
        async function loadMitarbeiterTable() {
            const res = await fetch('/mitarbeiter');
            const data = await res.json();
            const tbody = document.getElementById('maTable'); tbody.innerHTML = '';
            data.forEach(m => {
                const json = JSON.stringify(m).replace(/"/g, '&quot;');
                tbody.innerHTML += `<tr><td>${m.username}</td><td>${m.vorname} ${m.nachname}</td><td>${m.rolle}</td><td>
                    <button class="edit" onclick="editMitarbeiter(${json})">Edit</button>
                    <button class="delete" onclick="deleteMitarbeiter(${m.id})">LÃ¶schen</button>
                </td></tr>`;
            });
        }
        
        function editMitarbeiter(m) {
            document.getElementById('lblMA').innerText = "Bearbeiten (ID: " + m.id + ")";
            document.getElementById('btnMA').innerText = "Speichern";
            document.getElementById('btnCancelM').classList.remove('hidden');
            document.getElementById('editM_Id').value = m.id;
            document.getElementById('newM_User').value = m.username;
            document.getElementById('newM_Vor').value = m.vorname;
            document.getElementById('newM_Nach').value = m.nachname;
            document.getElementById('newM_Rolle').value = m.rolle;
        }

        function resetMitarbeiterForm() {
            document.getElementById('lblMA').innerText = "ðŸ‘· Neuer Mitarbeiter";
            document.getElementById('btnMA').innerText = "Mitarbeiter anlegen";
            document.getElementById('btnCancelM').classList.add('hidden');
            document.getElementById('editM_Id').value = '';
            document.getElementById('newM_User').value = '';
            document.getElementById('msgMitarbeiter').innerText = '';
        }

        async function saveMitarbeiter() {
            const id = document.getElementById('editM_Id').value;
            const body = {
                username: document.getElementById('newM_User').value,
                password: document.getElementById('newM_Pass').value,
                vorname: document.getElementById('newM_Vor').value,
                nachname: document.getElementById('newM_Nach').value,
                rolle: document.getElementById('newM_Rolle').value
            };
            const url = id ? '/mitarbeiter/' + id : '/mitarbeiter';
            const method = id ? 'PUT' : 'POST';
            try {
                const res = await fetch(url, { method: method, headers: {'Content-Type':'application/json', 'Authorization':'Bearer '+localStorage.getItem('token')}, body:JSON.stringify(body)});
                if(res.ok) { 
                    document.getElementById('msgMitarbeiter').innerText = "Gespeichert!"; 
                    document.getElementById('msgMitarbeiter').className = "msg-success";
                    resetMitarbeiterForm(); loadMitarbeiterTable(); loadDropdowns();
                } else { 
                    await handleError(res, 'msgMitarbeiter');
                }
            } catch(e) { alert(e); }
        }

        async function deleteMitarbeiter(id) {
            if(!confirm("LÃ¶schen?")) return;
            await fetch('/mitarbeiter/'+id, {method:'DELETE', headers:{'Authorization':'Bearer '+localStorage.getItem('token')}});
            loadMitarbeiterTable(); loadDropdowns();
        }
        
        // --- TERMIN LOGIK ---
        async function loadDropdowns() {
            const [rk, rm] = await Promise.all([fetch('/kunden'), fetch('/mitarbeiter')]);
            const k = await rk.json(); const m = await rm.json();
            
            const selK = document.getElementById('newT_Kunde'); selK.innerHTML = '';
            k.forEach(x => selK.innerHTML += `<option value="${x.id}">${x.nachname}, ${x.vorname}</option>`);
            
            const selM = document.getElementById('newT_MA'); selM.innerHTML = '';
            m.forEach(x => selM.innerHTML += `<option value="${x.id}">${x.username}</option>`);
        }
        
        function editTermin(t) {
            document.getElementById('lblTermin').innerText = "Termin bearbeiten (ID: " + t.id + ")";
            document.getElementById('btnTermin').innerText = "Speichern";
            document.getElementById('btnCancelT').classList.remove('hidden');
            document.getElementById('editT_Id').value = t.id;
            document.getElementById('newT_Desc').value = t.beschreibung;
            document.getElementById('newT_Datum').value = t.datumUhrzeit; 
        }

        function resetTerminForm() {
            document.getElementById('lblTermin').innerText = "ðŸ“… Neuer Termin";
            document.getElementById('btnTermin').innerText = "Termin buchen";
            document.getElementById('btnCancelT').classList.add('hidden');
            document.getElementById('editT_Id').value = '';
            document.getElementById('newT_Desc').value = '';
            document.getElementById('msgTermin').innerText = '';
        }

        async function saveTermin() {
            const id = document.getElementById('editT_Id').value;
            const body = {
                datumUhrzeit: document.getElementById('newT_Datum').value,
                beschreibung: document.getElementById('newT_Desc').value,
                kundeId: parseInt(document.getElementById('newT_Kunde').value),
                mitarbeiterId: parseInt(document.getElementById('newT_MA').value)
            };
            const url = id ? '/termine/' + id : '/termine';
            const method = id ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, { method: method, headers: {'Content-Type':'application/json', 'Authorization':'Bearer '+localStorage.getItem('token')}, body:JSON.stringify(body)});
                if(res.ok) { 
                    document.getElementById('msgTermin').innerText = "Termin erfolgreich gebucht!"; 
                    document.getElementById('msgTermin').className = "msg-success";
                    resetTerminForm(); loadTermine(); 
                } else { 
                    // HIER RUFEN WIR DIE NEUE FUNKTION AUF:
                    await handleError(res, 'msgTermin');
                }
            } catch(e) { alert(e); }
        }

        async function deleteTermin(id) {
            if(!confirm("LÃ¶schen?")) return;
            await fetch('/termine/'+id, {method:'DELETE', headers:{'Authorization':'Bearer '+localStorage.getItem('token')}});
            loadTermine();
        }
    </script>
</body>
</html>
